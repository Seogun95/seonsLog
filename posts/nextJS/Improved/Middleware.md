# Middleware

[κ³µμ‹ λ¬Έμ„ - λ―Έλ“¤μ›¨μ–΄](https://nextjs.org/docs/app/building-your-application/routing/middleware)

λ―Έλ“¤μ›¨μ–΄λ” μ›Ήμ‚¬μ΄νΈμ—μ„ μ”μ²­μ΄ μ²λ¦¬λκΈ° μ „μ— μ‹¤ν–‰λλ©° `Vercel` ν™κ²½μ—μ„λ” νΉμ΄ν•κ²λ„ μΊμ‹λ³΄λ‹¤ λ¨Όμ € μν–‰λ©λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ λ„κµ¬λ‚ μ ‘κ·Όν•  μ μ—†λ” κ°μΈν™”λ μ½ν…μΈ (μ: νΉμ • μ‚¬μ©μμ SSRνμ΄μ§€)λ¥Ό CDNμ— μΊμ‹±ν•μ—¬ λΉ λ¥Έ μ‘λ‹µμ„ μλ„ν•μ—¬λ„ κ°μΈν™”ν•μ—¬ μ κ³µν•  μ μμΌλ©° κ·Έλ° λ°©μ‹μ— ν¨κ³Όμ μ΄λΌκ³  ν•©λ‹λ‹¤.

λ―Έλ“¤μ›¨μ–΄μ—μ„λ” `Request` κ°μ²΄μ™€ `Response` κ°μ²΄μ— μ ‘κ·Όν•  μ μμΌλ©°, μ΄λ¥Ό ν™μ©ν•΄ μ”μ²­ μ •λ³΄λ¥Ό λ°›μ•„μ™€ λ¶€κ°€μ μΈ μ²λ¦¬λ¥Ό ν•κ³  μ‘λ‹µ κ°μ²΄μ— λ¬΄μ–Έκ°€λ¥Ό μ¶”κ°€ν•κ±°λ‚ μ‘λ‹µμ„ λ³€κ²½ν•  μ μμµλ‹λ‹¤.

- νμ΄μ§€ λ λ”λ§ μ „μ— μΈμ¦μ„ ν™•μΈν•κ±°λ‚ μ”μ²­μ„ ν™•μΈν•©λ‹λ‹¤.
- μ”μ²­ λ°μ΄ν„°λ¥Ό μ‚¬μ „μ— μ²λ¦¬ν•κ±°λ‚ νΉμ • API μ”μ²­μ„ μν–‰ν•κ±°λ‚ μΊμ‹λ¥Ό κ΄€λ¦¬ν•©λ‹λ‹¤.
- μ”μ²­μ— λ€ν• μ‘λ‹µμ„ λ³€ν™ν•κ±°λ‚ μ—λ¬λ¥Ό μ²λ¦¬ν•  μ μμµλ‹λ‹¤.

κ°„λ‹¨ν λ§ν•΄, λ―Έλ“¤μ›¨μ–΄λ” λ¬Έμ§€κΈ° μ—­ν• μ„ ν•λ‹¤κ³  μƒκ°ν•λ©΄ λ©λ‹λ‹¤. λ΅κ·ΈμΈν•μ§€ μ•μ€ μ‚¬μ©μλ¥Ό μ…κµ¬μ—μ„ μ§€μΌλ³΄λ‹¤κ°€ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ””λ ‰μ…ν•κ±°λ‚, κ³µν†µμ μΌλ΅ μν–‰ν•΄μ•Ό ν•λ” μ‘μ—…μ„ ν•κ±°λ‚, κ²€μ¦μ„ ν•  λ• μ‚¬μ©ν•  μ μμµλ‹λ‹¤.

## μ‚¬μ© λ°©λ²•

Next.js 13μ—μ„ λ―Έλ“¤μ›¨μ–΄λ¥Ό μ‚¬μ©ν•κΈ° μ„ν•΄μ„λ” `app` ν΄λ”κ°€ μ•„λ‹ μµμƒμ„ ν΄λ”μΈ `src`μ—μ„ μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.

```
π“¦src
β”— π“middleware.ts
```

```ts
import { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  console.log('λ―Έλ“¤μ›¨μ–΄ μ²΄ν‚Ή β…');
}
```

λ¨Όμ € μ„μ™€ κ°™μ΄ λ―Έλ“¤μ›¨μ–΄κ°€ μ μ‘λ™ν•λ”μ§€ μ½μ†”μ„ ν†µν•΄ ν™•μΈν•  μ μμµλ‹λ‹¤. μ΄λ ‡κ² ν•λ©΄ λ¨λ“  νμ΄μ§€μ— μ ‘κ·Όν•  λ• λ―Έλ“¤μ›¨μ–΄κ°€ μ „μ—­μΌλ΅ μ‚¬μ©λκ³  μλ”μ§€ ν™•μΈν•  μ μμµλ‹λ‹¤. μ¦‰, λ¨λ“  μ”μ²­μ— λ€ν•΄μ„ κ²€μ‚¬ν•  μ μμµλ‹λ‹¤.

```tsx
import { NextRequest, NextResponse } from 'next/server';

export const middleware = (request: NextRequest) => {
  console.log('λ―Έλ“¤μ›¨μ–΄ μ²΄ν‚Ή β…');
  if (request.nextUrl.pathname.startsWith('/settings/middleware')) {
    console.log(`${request.url}μ΄ ν™μΌλ΅ μ΄λ™ν•©λ‹λ‹¤!`);
    return NextResponse.redirect(new URL('/', request.url));
  }
};
```

![](https://i.imgur.com/mtLmbfn.gif)


## config

λ§μ•½ νΉμ •ν• νμ΄μ§€μ—μ„λ§ μ‹¤ν–‰μ΄ ν•„μ”ν•λ‹¤λ©΄, μ•„λμ™€ κ°™μ΄ μ„¤μ •ν•  μ μμµλ‹λ‹¤.

```ts
export const config = {
  matcher: ['/settings/:path+'],
};
```

`export const config`λ” λ―Έλ“¤μ›¨μ–΄μ κµ¬μ„± μµμ…μ„ μ •μν•λ” κ°μ²΄μ…λ‹λ‹¤. μ—¬κΈ°μ„ `matcher`λ” λ―Έλ“¤μ›¨μ–΄λ¥Ό μ μ©ν•  κ²½λ΅ ν¨ν„΄μ„ μ§€μ •ν•λ” μµμ…μ…λ‹λ‹¤.

`matcher: ['/settings/:path+']`λ” `/settings` κ²½λ΅λ¥Ό μ μ™Έν• `settings/slug` λ‹¤μ΄λ‚λ―Ή κ²½λ΅μ— ν•΄λ‹Ήν•λ” λ¨λ“  κ²½λ΅μ—μ„ λ―Έλ“¤μ›¨μ–΄λ¥Ό μ‚¬μ©ν•λ„λ΅ μ„¤μ •ν• κ²ƒμ…λ‹λ‹¤.

μ—¬κΈ°μ„ `:path+`λ” `:`μΌλ΅ μ‹μ‘ν•λ” λ™μ  κ²½λ΅ μ„Έκ·Έλ¨ΌνΈλ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤. `+`λ” ν•΄λ‹Ή μ„Έκ·Έλ¨ΌνΈκ°€ ν•λ‚ μ΄μƒμ κ²½λ΅ μ„Έκ·Έλ¨ΌνΈλ¥Ό ν¬ν•¨ν•λ‹¤λ” κ²ƒμ„ μλ―Έν•©λ‹λ‹¤. λ”°λΌμ„ `/settings/slug`λΏλ§ μ•„λ‹λΌ `/settings/abc/123`κ³Ό κ°™μ€ κ²½λ΅μ—λ„ λ―Έλ“¤μ›¨μ–΄κ°€ μ μ©λ©λ‹λ‹¤.

μ΄λ ‡κ² μ„¤μ •λ `matcher` μµμ…μ€ ν•΄λ‹Ή κ²½λ΅ ν¨ν„΄μ— λ§¤μΉ­λλ” λ¨λ“  μ”μ²­μ— λ€ν•΄ λ―Έλ“¤μ›¨μ–΄ ν•¨μκ°€ μ‹¤ν–‰λλ„λ΅ ν•©λ‹λ‹¤.

μ°Έκ³ λ΅ μ •κ·μ‹ ν‘ν„λ²•μ—μ„ `*` μ€ path ν¬ν•¨ λ¨λ“  κ²½λ΅μ—μ„ middleware μ‚¬μ©λκ³ , `+`λ” path λ―Έν¬ν•¨ λ¨λ“  κ²½λ΅μ—μ„ middleware μ‚¬μ©λ©λ‹λ‹¤.

![](https://i.imgur.com/WTkbhwA.gif)

λν•, μμƒμ„ ν†µν•΄ ν™•μΈν•  μ μλ“―μ΄, `settings` κ²½λ΅μ—μ„ λ‹¤μ΄λ‚λ―Ή κ²½λ΅μ— λ§μ°μ¤λ¥Ό μ¬λ¦¬λ©΄ Next.jsμ—μ„ λ°μ΄ν„°λ¥Ό λ―Έλ¦¬ κ°€μ Έμ¤λ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.


## λ―Έλ“¤μ›¨μ–΄ μ‹¤ν–‰ μμ„

λ‹¤μμ€ ν”„λ΅μ νΈμ λ¨λ“  λΌμ°νΈμ— λ€ν•΄ λ―Έλ“¤μ›¨μ–΄κ°€ νΈμ¶λλ” μ‹¤ν–‰ μμ„μ…λ‹λ‹¤. 

1. `next.config.js`μ header μ‹¤ν–‰
2. `next.config.js`μ redirects μ‹¤ν–‰
3. **Middleware (rewrites, redirects, etc.) μ‹¤ν–‰**
4.  `next.config.js`μ `beforeFiles` (rewrites) μ‹¤ν–‰
5. Filesystem routes (`public/`, `_next/static/`, `pages/`, `app/`, etc.)
6.  `next.config.js`μ `afterFiles` (rewrites) μ‹¤ν–‰
7. λ™μ  λΌμ°ν… μ‹¤ν–‰ (`/blog/[slug]`)
8. `next.config.js`μ `fallback` (rewrites) μ‹¤ν–‰

μ΄ μμ„λ€λ΅ κ°κ°μ λ‹¨κ³„μ—μ„ ν•΄λ‹Ήν•λ” μ‘μ—…μ΄ μ‹¤ν–‰λ©λ‹λ‹¤.